function makeVideo(e){var t={};t.danmukuQueue=[];t.storage=[];t.id=e;t.volume=1;t.fullScreen=0;t.showDanmukuPanel=0;t.showDanmuku=1;t.danmukuPos="1";t.danmukuSpeed=200;t.danmukuColor="white";t.timingFlag="";t.topIndex=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];t.bottomIndex=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];t.scrollIndex=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];t.playerWhole=playerListOri[t.id].getElementsByClassName("main-player-zone")[0];t.controlBar=playerListOri[t.id].getElementsByClassName("main-control-bar")[0];t.danmukuBar=playerListOri[t.id].getElementsByClassName("main-danmuku-panel")[0];t.danmukuPanel=playerListOri[t.id].getElementsByClassName("main-danmuku-setting")[0];t.playBtn=playerListOri[t.id].getElementsByClassName("main-play-status")[0];t.video=playerListOri[t.id].getElementsByTagName("video")[0];t.progressBarOuter=playerListOri[t.id].getElementsByClassName("main-progress")[0];t.progressBarInner=playerListOri[t.id].getElementsByClassName("main-progress-inner")[0];t.volumeBtn=playerListOri[t.id].getElementsByClassName("main-control-vol-img")[0];t.volumeDropOuter=playerListOri[t.id].getElementsByClassName("main-control-vol-outer")[0];t.volumeDropInner=playerListOri[t.id].getElementsByClassName("main-control-vol-inner")[0];t.danmukuBtn=playerListOri[t.id].getElementsByClassName("main-control-danmuku-switch")[0];t.fullScreenBtn=playerListOri[t.id].getElementsByClassName("main-control-full-screen")[0];t.danmukuPanelBtn=playerListOri[t.id].getElementsByClassName("main-danmuku-control-btn")[0];t.danmukuBiuBtn=playerListOri[t.id].getElementsByClassName("main-danmuku-biu-btn")[0];t.danmukuInput=playerListOri[t.id].getElementsByClassName("main-danmuku-input-bar")[0];t.danmuku=playerListOri[t.id].getElementsByClassName("main-zone-danmuku")[0];t.timeCount=playerListOri[t.id].getElementsByClassName("main-time-counter")[0];t.playerIDBlock=playerListOri[t.id].getElementsByClassName("player-ID")[0];t.insertDanmuku=function e(n){t.danmukuQueue.push(n);t.danmukuQueue.sort(function(e,t){return e.time-t.time})};t.loadStorage=function(){var e="danmukuPool_"+t.id;if(!window.localStorage.getItem(e)){var n={pos:"2",col:"white",spd:200,ctx:t.id+" 这是自动初始化的弹幕",time:0};t.storage.push(n);localStorage.setItem(e,JSON.stringify(t.storage));t.danmukuQueue.push(n)}else{t.storage=JSON.parse(localStorage.getItem(e));for(var i in t.storage){if(t.storage.hasOwnProperty(i)){t.insertDanmuku(t.storage[i])}}}};t.bindDanmukuPanelPosition=function(){var e=playerListOri[t.id].getElementsByClassName("main-danmuku-position")[0].getElementsByTagName("div");for(var n in e){if(e.hasOwnProperty(n)){e[n].addEventListener("click",function(e){t.danmukuPos=e.target.dataset.pos;e.target.classList.add("danmuku-positon-select");var n=t.sibilings(e.target);for(var i in n){if(n.hasOwnProperty(i)){n[i].classList.remove("danmuku-positon-select")}}})}}};t.bindDanmukuPanelColor=function(){var e=playerListOri[t.id].getElementsByClassName("main-danmuku-color")[0].getElementsByTagName("span");for(var n in e){if(e.hasOwnProperty(n)){e[n].addEventListener("click",function(e){t.danmukuColor=e.target.dataset.col;e.target.classList.add("danmuku-color-select");var n=t.sibilings(e.target);for(var i in n){if(n.hasOwnProperty(i)){n[i].classList.remove("danmuku-color-select")}}})}}};t.bindDanmukuPanelSpeed=function(){var e=playerListOri[t.id].getElementsByClassName("main-danmuku-speed")[0].getElementsByTagName("div");for(var n in e){if(e.hasOwnProperty(n)){e[n].addEventListener("click",function(e){t.danmukuSpeed=parseInt(e.target.dataset.spd);e.target.classList.add("danmuku-speed-select");var n=t.sibilings(e.target);for(var i in n){if(n.hasOwnProperty(i)){n[i].classList.remove("danmuku-speed-select")}}})}}};t.danmukuFresh=function(e){while(t.danmukuQueue.length){if(t.danmukuQueue[0].time>e){break}else{t.formatShoot(t.danmukuQueue[0]);t.danmukuQueue.shift()}}};t.formatShoot=function e(n){var i=document.createElement("div");i.appendChild(document.createTextNode(n.ctx));i.style.color=n.col;switch(n.pos){case"1":{var a=0;for(var r=0;r<=19;r++){if(t.scrollIndex[r]<t.scrollIndex[a]){a=r}}t.scrollIndex[a]++;t.danmuku.appendChild(i);i.style.display="block";i.style.top=a*30+"px";i.style.right="-"+i.offsetWidth+"px";var s=(t.danmuku.offsetWidth+i.offsetWidth)/n.spd;i.style.transitionDuration=s+"s";i.style.transform="translateX(-"+(t.danmuku.offsetWidth+i.offsetWidth)+"px)";setTimeout(function(){t.scrollIndex[a]--},i.offsetWidth*1e3/n.spd);setTimeout(function(){t.danmuku.removeChild(i)},s*1e3);break}case"2":{var l=0;for(var o=0;o<=19;o++){if(t.topIndex[o]<t.topIndex[l]){l=o}}t.topIndex[l]++;i.style.top=l*30+"px";t.danmuku.appendChild(i);i.style.display="block";i.style.left=(t.danmuku.offsetWidth-i.offsetWidth)/2+"px";setTimeout(function(){t.topIndex[l]--;t.danmuku.removeChild(i)},5e3);break}case"3":{var u=0;for(var d=0;d<=19;d++){if(t.bottomIndex[d]<t.bottomIndex[u]){u=d}}t.bottomIndex[u]++;i.style.bottom=u*30+"px";t.danmuku.appendChild(i);i.style.display="block";i.style.left=(t.danmuku.offsetWidth-i.offsetWidth)/2+"px";setTimeout(function(){t.bottomIndex[u]--;t.danmuku.removeChild(i)},5e3);break}}};t.shootDanmuku=function(){var e=t.danmukuInput.value;if(e.length){t.danmukuInput.value="";var n={pos:t.danmukuPos,col:t.danmukuColor,spd:t.danmukuSpeed,ctx:e,time:parseFloat(t.video.currentTime.toFixed(1))};var i="danmukuPool_"+t.id;t.storage.push(n);localStorage.setItem(i,JSON.stringify(t.storage));t.insertDanmuku(n)}};t.toggleDanmukuPanel=function e(){if(!t.showDanmukuPanel){t.danmukuPanel.style.display="block";t.danmukuPanelBtn.getElementsByTagName("img")[0].setAttribute("src","images/panel_off.png")}else{t.danmukuPanel.style.display="none";t.danmukuPanelBtn.getElementsByTagName("img")[0].setAttribute("src","images/panel_on.png")}t.showDanmukuPanel=!t.showDanmukuPanel};t.seekQueue=function(){t.danmukuQueue=[];for(var e in t.storage){if(t.storage.hasOwnProperty(e)){if(t.storage[e].time>=t.video.currentTime){t.insertDanmuku(t.storage[e])}}}};t.toggleDanmuku=function(){if(t.showDanmuku){t.danmuku.style.display="none";t.danmukuBtn.getElementsByTagName("img")[0].setAttribute("src","images/no_danmu.png")}else{t.danmuku.style.display="block";t.danmukuBtn.getElementsByTagName("img")[0].setAttribute("src","images/danmu.png")}t.showDanmuku=!t.showDanmuku};t.videoEnd=function(){t.videoPause();t.video.currentTime=0;t.progressBarInner.style.width="0";t.updateProgressBar()};t.toggleFullScreenIcon=function(){if(document.webkitIsFullScreen){t.fullScreen=1;t.fullScreenBtn.getElementsByTagName("img")[0].setAttribute("src","images/no_full.png")}else{t.fullScreen=0;t.fullScreenBtn.getElementsByTagName("img")[0].setAttribute("src","images/full.png")}};t.toggleFullScreen=function(){if(!t.fullScreen){t.playerWhole.webkitRequestFullScreen()}else{document.webkitCancelFullScreen()}};t.setVolume=function(e){var n=t.getTop(t.volumeDropOuter)+t.volumeDropOuter.offsetHeight-e.pageY;var i=n/t.volumeDropOuter.offsetHeight;t.volumeDropInner.style.height=t.volumeDropOuter.offsetHeight*i+"px";t.volume=i;t.video.volume=t.volume;if(t.volume>=.5){t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/v_up.png")}else if(t.volume>=0){t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/v_down.png")}else{t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/mute.png")}};t.videoMute=function(){if(t.video.volume!==0){t.volume=t.video.volume;t.video.volume=0;t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/mute.png");t.volumeDropInner.style.height="0"}else{t.video.volume=t.volume;t.volumeDropInner.style.height=t.volumeDropOuter.offsetHeight*t.volume+"px";if(t.volume>=.5){t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/v_up.png")}else{t.volumeBtn.getElementsByTagName("img")[0].setAttribute("src","images/v_down.png")}}};t.videoSeek=function(e){clearInterval(t.timingFlag);var n=e.pageX-t.getLeft(t.progressBarOuter);var i=n/t.progressBarOuter.offsetWidth;t.progressBarInner.style.width=t.progressBarOuter.offsetWidth*i+"px";t.video.currentTime=t.video.duration*i;t.seekQueue();if(!t.video.ended&&!t.video.paused){t.timingFlag=setInterval(t.updateProgressBar,50)}};t.toTwo=function(e){return e<0?"00":e<10?"0"+parseInt(e).toString():parseInt(e).toString()};t.initDuration=function(){var e=t.toTwo(t.video.duration/60);var n=t.toTwo(t.video.duration-e*60);t.timeCount.innerHTML="00:00/"+e+":"+n};t.updateProgressBar=function e(){var n=t.video.currentTime/t.video.duration;t.progressBarInner.style.width=t.progressBarOuter.offsetWidth*n+"px";var i=t.toTwo(t.video.currentTime/60);var a=t.toTwo(t.video.currentTime-60*i);var r=t.toTwo(t.video.duration/60);var s=t.toTwo(t.video.duration-r*60);t.timeCount.innerHTML=i+":"+a+"/"+r+":"+s;t.danmukuFresh(t.video.currentTime.toFixed(1))};t.videoPlay=function e(){t.video.play();t.timingFlag=setInterval(t.updateProgressBar,50);t.playBtn.getElementsByTagName("img")[0].setAttribute("src","images/pause.png")};t.videoPause=function(){t.video.pause();clearInterval(t.timingFlag);t.playBtn.getElementsByTagName("img")[0].setAttribute("src","images/play.png")};t.togglePlay=function(){if(t.video.paused||t.video.ended){if(t.video.ended){t.video.currentTime=0}t.videoPlay()}else{t.videoPause()}};t.freshIDBlock=function(){for(var e in playerListOri){if(playerListOri.hasOwnProperty(e)){var n=parseInt(playerListOri[e].getElementsByClassName("player-ID")[0].innerHTML);if(n!==t.id){playerListOri[e].getElementsByClassName("player-ID")[0].classList.remove("player-select")}else{playerListOri[e].getElementsByClassName("player-ID")[0].classList.add("player-select");side.sideBarUpdate(t.id)}}}side.updateMiniVisble()};t.getLeft=function(e){var t=e.offsetLeft;var n=e.offsetParent;while(n!==null){t+=n.offsetLeft;n=n.offsetParent}return t};t.getTop=function(e){var t=e.offsetTop;var n=e.offsetParent;while(n!==null){t+=n.offsetTop;n=n.offsetParent}return t};t.sibilings=function(e){var t=[];var n=e.previousSibling;while(n){if(n.nodeType===1){t.push(n)}n=n.previousSibling}t.reverse();var i=e.nextSibling;while(i){if(i.nodeType===1){t.push(i)}i=i.nextSibling}return t};t.player={init:function(){t.video.removeAttribute("controls");t.loadStorage();t.video.oncanplaythrough=t.player.bindBtns();t.video.addEventListener("ended",t.videoEnd)},bindBtns:function(){t.initDuration();t.playBtn.addEventListener("click",t.togglePlay);t.video.addEventListener("click",t.togglePlay);t.danmuku.addEventListener("click",t.togglePlay);t.progressBarOuter.addEventListener("click",t.videoSeek);t.volumeBtn.addEventListener("click",t.videoMute);t.volumeDropOuter.addEventListener("click",t.setVolume);t.danmukuBtn.addEventListener("click",t.toggleDanmuku);t.fullScreenBtn.addEventListener("click",t.toggleFullScreen);t.playerWhole.addEventListener("webkitfullscreenchange",t.toggleFullScreenIcon);t.danmukuBiuBtn.addEventListener("click",t.shootDanmuku);t.danmukuPanelBtn.addEventListener("click",t.toggleDanmukuPanel);t.playerIDBlock.addEventListener("click",t.freshIDBlock);t.bindDanmukuPanelPosition();t.bindDanmukuPanelColor();t.bindDanmukuPanelSpeed()}};t.player.init();return t}function playerInitAll(){window.playerList=[];window.playerListOri=document.getElementsByClassName("player");if(!playerListOri.length){console.log("Error: No player find, module exit!");return}console.log("player(s) find : "+playerListOri.length);for(var e=0;e<playerListOri.length;++e){var t=playerListOri[e].getElementsByClassName("player-ID")[0];t.innerHTML=(e+1).toString();var n=makeVideo(e);playerList.push(n)}side.playerCount=playerListOri.length;side.sideBarUpdate(0);side.updateMiniVisble()}function SidePart(){var e={};e.playerCount=0;e.activeMiniID=0;e.isPlaying=0;e.miniPlayerInit=function(){var t=document.getElementById("mini-bar");var n=document.getElementById("mini-player");e.startDrag(t,n);window.addEventListener("scroll",e.updateMiniVisble);var i=n.getElementsByTagName("video")[0];i.addEventListener("click",a);function a(){if(!e.isPlaying){if(i.ended){i.duration=0}i.play();e.isPlaying=1}else{i.pause();e.isPlaying=0}}};e.updateMiniVisble=function(){var t=document.getElementById("mini-player");var n=playerListOri[e.activeMiniID].offsetTop-document.body.scrollTop;if(n<=0){if(-1*n>=playerListOri[e.activeMiniID].offsetHeight){t.style.display="block";if(!e.isPlaying){if(!playerList[e.activeMiniID].video.paused&&!playerList[e.activeMiniID].video.ended){e.isPlaying=1;e.receive()}}}else{if(t.style.display!=="none"){t.style.display="none";if(playerList[e.activeMiniID].video.paused||playerList[e.activeMiniID].video.ended){e.drawBack()}}}}else{if(n>=playerListOri[e.activeMiniID].offsetHeight){t.style.display="block";if(!e.isPlaying){if(!playerList[e.activeMiniID].video.paused&&!playerList[e.activeMiniID].video.ended){e.isPlaying=1;e.receive()}}}else{if(t.style.display!=="none"){t.style.display="none";if(playerList[e.activeMiniID].video.paused||playerList[e.activeMiniID].video.ended){e.drawBack()}}}}};e.drawBack=function(){var t=document.getElementById("mini-player");var n=t.getElementsByTagName("video")[0];var i=playerList[e.activeMiniID].video;i.currentTime=n.currentTime;if(e.isPlaying){n.pause();playerList[e.activeMiniID].videoPlay()}e.isPlaying=0};e.receive=function(){var t=document.getElementById("mini-player");var n=t.getElementsByTagName("video")[0];var i=playerList[e.activeMiniID].video;n.currentTime=i.currentTime;if(!i.paused&&!i.ended){playerList[e.activeMiniID].videoPause();n.play()}};window.params={left:0,top:0,currentX:0,currentY:0,flag:false};e.getCss=function(e,t){return document.defaultView.getComputedStyle(e)[t]};e.startDrag=function(t,n){if(e.getCss(n,"left")!=="auto"){params.left=e.getCss(n,"left")}if(e.getCss(n,"top")!=="auto"){params.top=e.getCss(n,"top")}t.onmousedown=function(e){params.flag=true;if(!e){e=window.event;t.onselectstart=function(){return false}}var n=e;params.currentX=n.clientX;params.currentY=n.clientY};document.onmouseup=function(){params.flag=false;if(e.getCss(n,"left")!=="auto"){params.left=e.getCss(n,"left")}if(e.getCss(n,"top")!=="auto"){params.top=e.getCss(n,"top")}};document.onmousemove=function(e){var t=e?e:window.event;if(params.flag){var i=t.clientX,a=t.clientY;var r=i-params.currentX,s=a-params.currentY;n.style.left=parseInt(params.left.toString())+r+"px";n.style.top=parseInt(params.top.toString())+s+"px";if(e.preventDefault){e.preventDefault()}return false}}};e.sideBarUpdate=function(t){e.activeMiniID=t;console.log("update status bar : "+e.playerCount+" "+e.activeMiniID);document.getElementById("status-player-count").innerHTML=e.playerCount.toString();document.getElementById("status-mini-ID").innerHTML=e.activeMiniID.toString();var n=document.getElementById("mini-player");n.getElementsByTagName("video")[0].setAttribute("src","images/video/"+(t+1)+".mp4");n.getElementsByTagName("span")[0].innerHTML=t+1;e.isPlaying=0};return e}window.onload=function(){window.side=new SidePart;side.miniPlayerInit();playerInitAll()};